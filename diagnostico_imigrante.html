<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assistente MigratÃ³rio HumanitÃ¡rio â€“ Evoluzion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos bÃ¡sicos para o chat - mantÃ©m a aparÃªncia do Tailwind */
        #chatMessages {
            min-height: 300px; /* Garante uma altura mÃ­nima para a Ã¡rea de mensagens */
            max-height: 500px; /* Altura mÃ¡xima com scroll */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px; /* EspaÃ§o entre as mensagens */
        }
        .user-message {
            background-color: #dbeafe; /* bg-blue-100 */
            align-self: flex-end;
            margin-left: auto;
            text-align: right;
            padding: 10px 14px;
            border-radius: 18px 18px 2px 18px; /* Borda arredondada diferenciada */
        }
        .gemini-message {
            background-color: #f3f4f6; /* bg-gray-100 */
            align-self: flex-start;
            margin-right: auto;
            text-align: left;
            padding: 10px 14px;
            border-radius: 18px 18px 18px 2px; /* Borda arredondada diferenciada */
        }
        .error-message {
            background-color: #fee2e2; /* bg-red-100 */
            color: #ef4444; /* text-red-500 */
            padding: 10px;
            border-radius: 8px;
            align-self: center;
            width: 100%;
            text-align: center;
        }
        .action-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-center;
            gap: 8px;
            margin-top: 16px;
            margin-bottom: 16px;
        }
        .action-button {
            @apply bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition;
            flex-grow: 1; /* Permite que os botÃµes cresÃ§am para preencher o espaÃ§o */
            min-width: 120px; /* Garante um tamanho mÃ­nimo */
        }
        .action-button.secondary {
            @apply bg-gray-300 hover:bg-gray-400 text-gray-800;
        }
        .flag-icon {
            margin-right: 8px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">

    <main class="max-w-xl mx-auto px-4 py-8 space-y-8">

        <!-- SeÃ§Ã£o do Chatbot Gemini -->
        <section id="chatSection" class="bg-white p-6 rounded-lg shadow-lg border-t-4 border-blue-600">
            
            <div id="chatMessages" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <!-- Mensagens do chat aparecerÃ£o aqui -->
            </div>

            <!-- Container para botÃµes de aÃ§Ã£o dinÃ¢micos -->
            <div id="actionButtonsContainer" class="action-buttons-container">
                <!-- BotÃµes serÃ£o injetados aqui via JavaScript -->
            </div>

            <div class="flex mt-4">
                <input type="text" id="chatInput" placeholder="Digite sua pergunta aqui..." class="flex-grow p-3 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <button id="chatSendBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-r-lg font-semibold transition">Enviar</button>
            </div>
            <p id="chatError" class="text-red-500 text-sm mt-2 hidden">Ocorreu um erro ao conectar com o assistente. Por favor, tente novamente.</p>
            <p id="chatLoading" class="text-blue-500 text-sm mt-2 hidden text-center">O assistente estÃ¡ digitando...</p>
        </section>
        <!-- Fim da SeÃ§Ã£o do Chatbot Gemini -->

        <section class="text-center mt-10">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Precisa de Ajuda Humana e Especializada?</h3>
            <a href="https://wa.me/5544984342756" target="_blank"
               class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-full font-semibold transition shadow-lg transform hover:scale-105">
                <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                Fale com nosso especialista!
            </a>
            <p class="mt-4 text-sm text-gray-600">Este assistente de IA oferece informaÃ§Ãµes gerais e nÃ£o substitui a consulta com um advogado de imigraÃ§Ã£o.</p>
        </section>

    </main>

    <footer class="bg-gray-900 text-white text-center text-sm py-4 mt-10">
        Assistente humanitÃ¡rio â€“ Evol.U.Zion ğŸŒ
    </footer>

    <script>
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const chatMessages = document.getElementById('chatMessages');
        const chatError = document.getElementById('chatError');
        const chatLoading = document.getElementById('chatLoading');
        const actionButtonsContainer = document.getElementById('actionButtonsContainer');

        let currentLanguage = 'pt'; // Idioma padrÃ£o (PortuguÃªs)
        // EstÃ¡gios da conversa
        let conversationStage = 'initial_greeting'; // Novo estÃ¡gio inicial
        let collectedData = {
            originCountry: null,
            currentLocation: null, // 'origin' ou 'foreign'
            currentStatus: null, // Apenas se 'foreign'
            destinationCountry: null,
            objective: null // Tipo de visto/serviÃ§o
        };

        // Tenta detectar o idioma do navegador para usar como idioma padrÃ£o
        const browserLanguage = navigator.language || navigator.userLanguage;
        if (browserLanguage) {
            if (browserLanguage.startsWith('en')) currentLanguage = 'en';
            else if (browserLanguage.startsWith('es')) currentLanguage = 'es';
            else if (browserLanguage.startsWith('fr')) currentLanguage = 'fr';
            else if (browserLanguage.startsWith('ru')) currentLanguage = 'ru';
            else if (browserLanguage.startsWith('ar')) currentLanguage = 'ar';
            else if (browserLanguage.startsWith('hi')) currentLanguage = 'hi';
            else if (browserLanguage.startsWith('zh')) currentLanguage = 'zh';
            else if (browserLanguage.startsWith('pt')) currentLanguage = 'pt';
        }

        let chatHistory = []; // Array para armazenar o histÃ³rico da conversa

        // --- IMPORTANTE: SUBSTITUA ESTE URL PELO SEU ENDPOINT REAL DO VERCEL FUNCTIONS ---
        const GEMINI_BACKEND_URL = 'https://assistente-gemini-backend.vercel.app/api/chat'; 

        // Mensagens para cada estÃ¡gio (agora mais focadas no que o frontend precisa)
        const stagePrompts = {
            initial_greeting: {
                pt: 'OlÃ¡! Eu sou seu Assistente MigratÃ³rio HumanitÃ¡rio da Evoluzion. Estou aqui para te ajudar com amizade, clareza e caminhos possÃ­veis sobre processos migratÃ³rios.',
                en: 'Hello! I am your Humanitarian Migration Assistant from Evoluzion. I\'m here to help you with friendship, clarity, and possible paths regarding migration processes.',
                es: 'Â¡Hola! Soy tu Asistente Migratorio Humanitario de Evoluzion. Estoy aquÃ­ para ayudarte con amistad, claridad y caminos posibles sobre procesos migratorios.',
                fr: 'Bonjour! Je suis votre Assistant Migratoire Humanitaire d\'Evoluzion. Je suis lÃ  pour vous aider avec amitiÃ©, clartÃ© et des chemins possibles concernant les processus migratoires.',
                ru: 'Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ! Ğ¯ Ğ²Ğ°Ñˆ Ğ³ÑƒĞ¼Ğ°Ğ½Ğ¸Ñ‚Ğ°Ñ€Ğ½Ñ‹Ğ¹ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº Ğ¾Ñ‚ Evoluzion. Ğ¯ Ğ·Ğ´ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ğ²Ğ°Ğ¼ Ñ Ğ´Ñ€ÑƒĞ¶ĞµĞ»ÑĞ±Ğ¸ĞµĞ¼, ÑÑĞ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿ÑƒÑ‚ÑĞ¼Ğ¸ Ğ² Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğ¸ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ².',
                ar: 'Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø¥Ù†Ø³Ø§Ù†ÙŠ Ù„Ù„Ù‡Ø¬Ø±Ø© Ù…Ù† Evoluzion. Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø¨Ø§Ù„ØµØ¯Ø§Ù‚Ø© ÙˆØ§Ù„ÙˆØ¶ÙˆØ­ ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù…ÙƒÙ†Ø© ÙÙŠÙ…Ø§ ÙŠØªØ¹Ù„Ù‚ Ø¨Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‡Ø¬Ø±Ø©.',
                hi: 'à¤¨à¤®à¤¸à¥à¤¤à¥‡! à¤®à¥ˆà¤‚ à¤à¤µà¥‹à¤²à¥à¤¯à¥‚à¤¶à¤¨ à¤¸à¥‡ à¤†à¤ªà¤•à¤¾ à¤®à¤¾à¤¨à¤µà¥€à¤¯ à¤ªà¥à¤°à¤µà¤¾à¤¸à¤¨ à¤¸à¤¹à¤¾à¤¯à¤• à¤¹à¥‚à¤à¥¤ à¤®à¥ˆà¤‚ à¤¯à¤¹à¤¾à¤ à¤†à¤ªà¤•à¥‹ à¤ªà¥à¤°à¤µà¤¾à¤¸à¤¨ à¤ªà¥à¤°à¤•à¥à¤°à¤¿à¤¯à¤¾à¤“à¤‚ à¤•à¥‡ à¤¸à¤‚à¤¬à¤‚à¤§ à¤®à¥‡à¤‚ à¤¦à¥‹à¤¸à¥à¤¤à¥€, à¤¸à¥à¤ªà¤·à¥à¤Ÿà¤¤à¤¾ à¤”à¤° à¤¸à¤‚à¤­à¤¾à¤µà¤¿à¤¤ à¤°à¤¾à¤¸à¥à¤¤à¥‹à¤‚ à¤•à¥‡ à¤¸à¤¾à¤¥ à¤®à¤¦à¤¦ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤¹à¥‚à¤à¥¤',
                zh: 'æ‚¨å¥½ï¼æˆ‘æ˜¯Evoluzionçš„äººé“ä¸»ä¹‰ç§»æ°‘åŠ©æ‰‹ã€‚æˆ‘åœ¨è¿™é‡Œä»¥å‹å–„ã€æ¸…æ™°çš„æ–¹å¼ï¼Œä¸ºæ‚¨æä¾›ç§»æ°‘æµç¨‹çš„å¯èƒ½é€”å¾„ã€‚'
            },
            // As perguntas para os estÃ¡gios 'ask_origin', 'ask_current_location', etc.,
            // serÃ£o geradas pelo backend agora, para garantir o idioma correto.
            // O frontend apenas saberÃ¡ qual Ã© o PRÃ“XIMO estÃ¡gio.
            ask_current_location_options: [
                { value: 'no_origin_country', text: 'Estou no meu paÃ­s de origem' },
                { value: 'foreign_country', text: 'Estou em um paÃ­s estrangeiro' }
            ],
            ask_objective_options: [
                { value: 'Visto de Visita', text: 'Visto de Visita' },
                { value: 'Visto de Trabalho', text: 'Visto de Trabalho' },
                { value: 'ResidÃªncia TemporÃ¡ria', text: 'ResidÃªncia TemporÃ¡ria' },
                { value: 'ResidÃªncia Permanente', text: 'ResidÃªncia Permanente' },
                { value: 'RefÃºgio', text: 'RefÃºgio' },
                { value: 'Anistia', text: 'Anistia' },
                { value: 'ReuniÃ£o Familiar', text: 'ReuniÃ£o Familiar' },
                { value: 'Outro', text: 'Outro' }
            ]
        };

        /**
         * Adiciona uma mensagem ao histÃ³rico do chat na interface e no array chatHistory.
         * @param {string} message - O texto da mensagem.
         * @param {string} sender - O remetente da mensagem ('user', 'gemini', 'error').
         * @param {boolean} [addToHistory=true] - Se a mensagem deve ser adicionada ao chatHistory para a IA.
         */
        function displayMessage(message, sender, addToHistory = true) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('p-3', 'rounded-lg', 'max-w-[85%]', 'break-words'); 

            if (sender === 'user') {
                messageElement.classList.add('user-message');
                messageElement.innerHTML = `<strong class="font-medium">${getLocalizedSenderName('user')}:</strong> ${message}`;
                if (addToHistory) chatHistory.push({ role: 'user', parts: [{ text: message }] });
            } else if (sender === 'gemini') {
                messageElement.classList.add('gemini-message');
                messageElement.innerHTML = `<strong class="font-medium">${getLocalizedSenderName('gemini')}:</strong> ${message}`;
                if (addToHistory) chatHistory.push({ role: 'model', parts: [{ text: message }] });
            } else if (sender === 'error') {
                messageElement.classList.add('error-message');
                messageElement.innerHTML = `<strong class="font-medium">${getLocalizedSenderName('error')}:</strong> ${message}`;
            }
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight; 
        }

        /**
         * Retorna o nome do remetente localizado.
         */
        function getLocalizedSenderName(sender) {
            const names = {
                pt: { user: 'VocÃª', gemini: 'Assistente', error: 'Erro' },
                en: { user: 'You', gemini: 'Assistant', error: 'Error' },
                es: { user: 'TÃº', gemini: 'Asistente', error: 'Error' },
                fr: { user: 'Vous', gemini: 'Assistant', error: 'Erreur' },
                ru: { user: 'Ğ’Ñ‹', gemini: 'ĞÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚', error: 'ĞÑˆĞ¸Ğ±ĞºĞ°' },
                ar: { user: 'Ø£Ù†Øª', gemini: 'Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯', error: 'Ø®Ø·Ø£' },
                hi: { user: 'à¤†à¤ª', gemini: 'à¤¸à¤¹à¤¾à¤¯à¤•', error: 'à¤¤à¥à¤°à¥à¤Ÿà¤¿' },
                zh: { user: 'æ‚¨', gemini: 'åŠ©æ‰‹', error: 'é”™è¯¯' }
            };
            return names[currentLanguage]?.[sender] || names.pt[sender];
        }

        /**
         * Renderiza botÃµes de aÃ§Ã£o na interface.
         * @param {Array<Object>} buttons - Array de objetos { value: string, text: string, type?: string }.
         */
        function renderButtons(buttons) {
            actionButtonsContainer.innerHTML = ''; // Limpa botÃµes anteriores
            buttons.forEach(buttonData => {
                const button = document.createElement('button');
                button.classList.add('action-button');
                if (buttonData.type === 'secondary') {
                    button.classList.add('secondary');
                }
                button.textContent = buttonData.text;
                button.dataset.value = buttonData.value;
                actionButtonsContainer.appendChild(button);
            });
            chatInput.disabled = true; // Desabilita o input enquanto os botÃµes estÃ£o ativos
            chatSendBtn.disabled = true;
        }

        /**
         * Limpa os botÃµes de aÃ§Ã£o e reabilita o input.
         */
        function clearButtons() {
            actionButtonsContainer.innerHTML = '';
            chatInput.disabled = false;
            chatSendBtn.disabled = false;
            chatInput.focus();
        }

        /**
         * Gerencia o fluxo da conversa baseado no estÃ¡gio atual.
         * @param {string} input - O texto ou valor do botÃ£o clicado.
         */
        async function handleConversationFlow(input) {
            clearButtons(); // Limpa botÃµes existentes antes de processar

            // A primeira mensagem (multilÃ­ngue) Ã© exibida no DOMContentLoaded
            if (conversationStage === 'initial_greeting') {
                // ApÃ³s a saudaÃ§Ã£o inicial, perguntamos o paÃ­s de origem
                await sendChatMessageToAI('', 'ask_origin'); // Envia mensagem vazia, mas com o estÃ¡gio
                conversationStage = 'ask_origin';
            } else if (conversationStage === 'ask_origin') {
                collectedData.originCountry = input;
                displayMessage(input, 'user'); // Exibe a escolha do usuÃ¡rio
                await sendChatMessageToAI('', 'ask_current_location');
                conversationStage = 'ask_current_location';
                // Renderiza botÃµes para "Estou no meu paÃ­s de origem" ou "Estou em um paÃ­s estrangeiro"
                renderButtons(stagePrompts.ask_current_location_options.map(opt => ({
                    value: opt.value,
                    text: getLocalizedButtonText(opt.value) // Localiza o texto do botÃ£o
                })));
            } else if (conversationStage === 'ask_current_location') {
                collectedData.currentLocation = input;
                displayMessage(input, 'user'); // Exibe a escolha do usuÃ¡rio
                if (input === 'foreign_country') { 
                    await sendChatMessageToAI('', 'ask_current_status');
                    conversationStage = 'ask_current_status';
                } else { // Se estiver no paÃ­s de origem
                    collectedData.currentStatus = 'no_foreign_status'; // Define um status padrÃ£o
                    await sendChatMessageToAI('', 'ask_destination');
                    conversationStage = 'ask_destination';
                }
                chatInput.focus();
            } else if (conversationStage === 'ask_current_status') {
                collectedData.currentStatus = input;
                displayMessage(input, 'user'); // Exibe a escolha do usuÃ¡rio
                await sendChatMessageToAI('', 'ask_destination');
                conversationStage = 'ask_destination';
                chatInput.focus();
            } else if (conversationStage === 'ask_destination') {
                collectedData.destinationCountry = input;
                displayMessage(input, 'user'); // Exibe a escolha do usuÃ¡rio
                await sendChatMessageToAI('', 'ask_objective');
                conversationStage = 'ask_objective';
                // Renderiza botÃµes para tipos de serviÃ§o
                renderButtons(stagePrompts.ask_objective_options.map(opt => ({
                    value: opt.value,
                    text: getLocalizedButtonText(opt.value) // Localiza o texto do botÃ£o
                })));
            } else if (conversationStage === 'ask_objective') {
                collectedData.objective = input;
                displayMessage(input, 'user'); // Exibe a escolha do usuÃ¡rio
                await sendChatMessageToAI('', 'generate_roadmap'); // Envia para gerar o roteiro
                conversationStage = 'chatting'; // Muda para o estÃ¡gio de chat livre
                
                // Adiciona o botÃ£o "Outro Assunto" apÃ³s o roteiro
                renderButtons([
                    { value: 'other_subject', text: getLocalizedButtonText('other_subject'), type: 'secondary' }
                ]);

            } else if (conversationStage === 'chatting') {
                if (input === 'other_subject') {
                    displayMessage(getLocalizedButtonText('other_subject'), 'user'); // Exibe "Outro Assunto"
                    await sendChatMessageToAI('', 'other_subject_prompt'); // Pede o novo assunto
                    conversationStage = 'other_subject_input';
                    chatInput.disabled = false; // Reabilita o input
                    chatSendBtn.disabled = false;
                    chatInput.focus();
                } else {
                    await sendChatMessageToAI(input, 'chatting'); // Chat livre, envia a mensagem do usuÃ¡rio
                    renderButtons([
                        { value: 'other_subject', text: getLocalizedButtonText('other_subject'), type: 'secondary' }
                    ]);
                }
            } else if (conversationStage === 'other_subject_input') {
                displayMessage(input, 'user'); // Exibe o novo assunto digitado
                // Reseta o contexto coletado para um novo assunto
                collectedData = {
                    originCountry: null,
                    currentLocation: null,
                    currentStatus: null,
                    destinationCountry: null,
                    objective: null
                }; 
                conversationStage = 'chatting'; // Volta para o modo de chat livre
                await sendChatMessageToAI(input, 'chatting'); // Envia o novo assunto para a IA
                renderButtons([
                    { value: 'other_subject', text: getLocalizedButtonText('other_subject'), type: 'secondary' }
                ]);
            }
        }

        /**
         * Retorna o texto localizado para botÃµes e prompts.
         */
        function getLocalizedButtonText(key) {
            const texts = {
                pt: {
                    no_origin_country: 'Estou no meu paÃ­s de origem',
                    foreign_country: 'Estou em um paÃ­s estrangeiro',
                    'Visto de Visita': 'Visto de Visita',
                    'Visto de Trabalho': 'Visto de Trabalho',
                    'ResidÃªncia TemporÃ¡ria': 'ResidÃªncia TemporÃ¡ria',
                    'ResidÃªncia Permanente': 'ResidÃªncia Permanente',
                    'RefÃºgio': 'RefÃºgio',
                    'Anistia': 'Anistia',
                    'ReuniÃ£o Familiar': 'ReuniÃ£o Familiar',
                    'Outro': 'Outro',
                    other_subject: 'Outro Assunto'
                },
                en: {
                    no_origin_country: 'I am in my country of origin',
                    foreign_country: 'I am in a foreign country',
                    'Visto de Visita': 'Tourist Visa',
                    'Visto de Trabalho': 'Work Visa',
                    'ResidÃªncia TemporÃ¡ria': 'Temporary Residence',
                    'ResidÃªncia Permanente': 'Permanent Residence',
                    'RefÃºgio': 'Refuge',
                    'Anistia': 'Amnesty',
                    'ReuniÃ£o Familiar': 'Family Reunification',
                    'Outro': 'Other',
                    other_subject: 'Other Subject'
                },
                es: {
                    no_origin_country: 'Estoy en mi paÃ­s de origen',
                    foreign_country: 'Estoy en un paÃ­s extranjero',
                    'Visto de Visita': 'Visa de Visita',
                    'Visto de Trabalho': 'Visa de Trabajo',
                    'ResidÃªncia TemporÃ¡ria': 'Residencia Temporal',
                    'ResidÃªncia Permanente': 'Residencia Permanente',
                    'RefÃºgio': 'Refugio',
                    'Anistia': 'AmnistÃ­a',
                    'ReuniÃ£o Familiar': 'ReunificaciÃ³n Familiar',
                    'Outro': 'Otro',
                    other_subject: 'Otro Tema'
                },
                fr: {
                    no_origin_country: 'Je suis dans mon pays d\'origine',
                    foreign_country: 'Je suis dans un pays Ã©tranger',
                    'Visto de Visita': 'Visa de Tourisme',
                    'Visto de Trabalho': 'Visa de Travail',
                    'ResidÃªncia TemporÃ¡ria': 'RÃ©sidence Temporaire',
                    'ResidÃªncia Permanente': 'RÃ©sidence Permanente',
                    'RefÃºgio': 'Refuge',
                    'Anistia': 'Amnistie',
                    'ReuniÃ£o Familiar': 'Regroupement Familial',
                    'Outro': 'Autre',
                    other_subject: 'Autre Sujet'
                },
                ru: {
                    no_origin_country: 'Ğ¯ Ğ² ÑĞ²Ğ¾ĞµĞ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ',
                    foreign_country: 'Ğ¯ Ğ² Ñ‡ÑƒĞ¶Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğµ',
                    'Visto de Visita': 'Ğ¢ÑƒÑ€Ğ¸ÑÑ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ²Ğ¸Ğ·Ğ°',
                    'Visto de Trabalho': 'Ğ Ğ°Ğ±Ğ¾Ñ‡Ğ°Ñ Ğ²Ğ¸Ğ·Ğ°',
                    'ResidÃªncia TemporÃ¡ria': 'Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¾Ğ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ',
                    'ResidÃªncia Permanente': 'ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¾Ğ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ',
                    'RefÃºgio': 'Ğ£Ğ±ĞµĞ¶Ğ¸Ñ‰Ğµ',
                    'Anistia': 'ĞĞ¼Ğ½Ğ¸ÑÑ‚Ğ¸Ñ',
                    'ReuniÃ£o Familiar': 'Ğ’Ğ¾ÑÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ ÑĞµĞ¼ÑŒĞ¸',
                    'Outro': 'Ğ”Ñ€ÑƒĞ³Ğ¾Ğµ',
                    other_subject: 'Ğ”Ñ€ÑƒĞ³Ğ°Ñ Ğ¢ĞµĞ¼Ğ°'
                },
                ar: {
                    no_origin_country: 'Ø£Ù†Ø§ ÙÙŠ Ø¨Ù„Ø¯ÙŠ Ø§Ù„Ø£ØµÙ„ÙŠ',
                    foreign_country: 'Ø£Ù†Ø§ ÙÙŠ Ø¨Ù„Ø¯ Ø£Ø¬Ù†Ø¨ÙŠ',
                    'Visto de Visita': 'ØªØ£Ø´ÙŠØ±Ø© Ø³ÙŠØ§Ø­Ø©',
                    'Visto de Trabalho': 'ØªØ£Ø´ÙŠØ±Ø© Ø¹Ù…Ù„',
                    'ResidÃªncia TemporÃ¡ria': 'Ø¥Ù‚Ø§Ù…Ø© Ù…Ø¤Ù‚ØªØ©',
                    'ResidÃªncia Permanente': 'Ø¥Ù‚Ø§Ù…Ø© Ø¯Ø§Ø¦Ù…Ø©',
                    'RefÃºgio': 'Ù„Ø¬ÙˆØ¡',
                    'Anistia': 'Ø¹ÙÙˆ',
                    'ReuniÃ£o Familiar': 'Ù„Ù… Ø´Ù…Ù„ Ø§Ù„Ø£Ø³Ø±Ø©',
                    'Outro': 'Ø¢Ø®Ø±',
                    other_subject: 'Ù…ÙˆØ¶ÙˆØ¹ Ø¢Ø®Ø±'
                },
                hi: {
                    no_origin_country: 'à¤®à¥ˆà¤‚ à¤…à¤ªà¤¨à¥‡ à¤®à¥‚à¤² à¤¦à¥‡à¤¶ à¤®à¥‡à¤‚ à¤¹à¥‚à¤',
                    foreign_country: 'à¤®à¥ˆà¤‚ à¤à¤• à¤µà¤¿à¤¦à¥‡à¤¶à¥€ à¤¦à¥‡à¤¶ à¤®à¥‡à¤‚ à¤¹à¥‚à¤',
                    'Visto de Visita': 'à¤ªà¤°à¥à¤¯à¤Ÿà¤• à¤µà¥€à¤œà¤¾',
                    'Visto de Trabalho': 'à¤•à¤¾à¤°à¥à¤¯ à¤µà¥€à¤œà¤¾',
                    'ResidÃªncia TemporÃ¡ria': 'à¤…à¤¸à¥à¤¥à¤¾à¤¯à¥€ à¤¨à¤¿à¤µà¤¾à¤¸',
                    'ResidÃªncia Permanente': 'à¤¸à¥à¤¥à¤¾à¤¯à¥€ à¤¨à¤¿à¤µà¤¾à¤¸',
                    'RefÃºgio': 'à¤¶à¤°à¤£',
                    'Anistia': 'à¤®à¤¾à¤«à¥€',
                    'ReuniÃ£o Familiar': 'à¤ªà¤°à¤¿à¤µà¤¾à¤° à¤•à¤¾ à¤ªà¥à¤¨à¤°à¥à¤®à¤¿à¤²à¤¨',
                    'Outro': 'à¤…à¤¨à¥à¤¯',
                    other_subject: 'à¤…à¤¨à¥à¤¯ à¤µà¤¿à¤·à¤¯'
                },
                zh: {
                    no_origin_country: 'æˆ‘åœ¨æˆ‘çš„åŸç±å›½',
                    foreign_country: 'æˆ‘åœ¨å¤–å›½',
                    'Visto de Visita': 'æ—…æ¸¸ç­¾è¯',
                    'Visto de Trabalho': 'å·¥ä½œç­¾è¯',
                    'ResidÃªncia TemporÃ¡ria': 'ä¸´æ—¶å±…ç•™',
                    'ResidÃªncia Permanente': 'æ°¸ä¹…å±…ç•™',
                    'RefÃºgio': 'é¿éš¾',
                    'Anistia': 'å¤§èµ¦',
                    'ReuniÃ£o Familiar': 'å®¶åº­å›¢èš',
                    'Outro': 'å…¶ä»–',
                    other_subject: 'å…¶ä»–ä¸»é¢˜'
                }
            };
            return texts[currentLanguage]?.[key] || texts.pt[key];
        }


        /**
         * Envia a mensagem (e o histÃ³rico + contexto) para o backend Gemini.
         * Esta funÃ§Ã£o Ã© chamada por handleConversationFlow quando Ã© a hora de falar com a IA.
         * @param {string} message - A mensagem a ser enviada para a IA.
         * @param {string} requestedStage - O estÃ¡gio que o backend deve responder (para gerar a pergunta correta).
         */
        async function sendChatMessageToAI(message, requestedStage) {
            chatInput.disabled = true;
            chatSendBtn.disabled = true;
            chatLoading.classList.remove('hidden');
            chatError.classList.add('hidden');

            try {
                const response = await fetch(GEMINI_BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message, // Mensagem do usuÃ¡rio ou vazia para prompts do assistente
                        language: currentLanguage, // Idioma detectado do navegador
                        chatHistory: chatHistory, // HistÃ³rico completo
                        // Envia o contexto coletado para o backend
                        originCountry: collectedData.originCountry,
                        currentLocation: collectedData.currentLocation,
                        currentStatus: collectedData.currentStatus,
                        destinationCountry: collectedData.destinationCountry,
                        objective: collectedData.objective,
                        // Indica ao backend o estÃ¡gio atual para que ele saiba o que responder
                        requestedStage: requestedStage 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Erro HTTP: ${response.status}`);
                }

                const data = await response.json();
                displayMessage(data.reply, 'gemini'); // Exibe a resposta do Gemini

            } catch (error) {
                console.error('Erro ao comunicar com o chatbot:', error);
                chatError.textContent = `NÃ£o foi possÃ­vel obter uma resposta do assistente. (${error.message})`;
                chatError.classList.remove('hidden');
                displayMessage('Desculpe, nÃ£o consegui processar sua solicitaÃ§Ã£o agora. Por favor, tente novamente.', 'error');
            } finally {
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
                chatLoading.classList.add('hidden'); 
                chatInput.focus();
            }
        }

        // Event Listener para cliques nos botÃµes de aÃ§Ã£o (como "Outro Assunto" ou opÃ§Ãµes de localizaÃ§Ã£o/serviÃ§o)
        actionButtonsContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('action-button')) {
                const value = event.target.dataset.value;
                handleConversationFlow(value);
            }
        });

        // Event Listeners para o envio de mensagens pelo input
        chatSendBtn.addEventListener('click', () => handleConversationFlow(chatInput.value));
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleConversationFlow(chatInput.value);
            }
        });

        // Inicializa a pÃ¡gina
        document.addEventListener('DOMContentLoaded', () => {
            // Mensagem inicial multilÃ­ngue combinada
            const combinedInitialMessage = `
                <p class="text-lg font-semibold"><span class="flag-icon">ğŸ‡§ğŸ‡·</span> Tire sua dÃºvida de viagem, imigraÃ§Ã£o e migraÃ§Ã£o abaixo.</p>
                <p class="text-base"><span class="flag-icon">ğŸ‡¬ğŸ‡§</span> Ask your travel, immigration, and migration questions below.</p>
                <p class="text-base"><span class="flag-icon">ğŸ‡ªğŸ‡¸</span> Resuelve tus dudas de viaje, inmigraciÃ³n y migraciÃ³n a continuaciÃ³n.</p>
                <p class="text-base"><span class="flag-icon">ğŸ‡«ğŸ‡·</span> Posez vos questions sur les voyages, l'immigration et la migration ci-dessous.</p>
                <p class="text-base"><span class="flag-icon">ğŸ‡·ğŸ‡º</span> Ğ—Ğ°Ğ´Ğ°Ğ¹Ñ‚Ğµ ÑĞ²Ğ¾Ğ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ğ¿ÑƒÑ‚ĞµÑˆĞµÑÑ‚Ğ²Ğ¸ÑÑ…, Ğ¸Ğ¼Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ¸Ğ¶Ğµ.</p>
                <p class="text-base"><span class="flag-icon">ğŸ‡¸ğŸ‡¦</span> Ø§Ø·Ø±Ø­ Ø£Ø³Ø¦Ù„ØªÙƒ Ø­ÙˆÙ„ Ø§Ù„Ø³ÙØ± ÙˆØ§Ù„Ù‡Ø¬Ø±Ø© ÙˆØ§Ù„Ù†Ø²ÙˆØ­ Ø£Ø¯Ù†Ø§Ù‡.</p>
                <p class="text-base"><span class="flag-icon">ğŸ‡®ğŸ‡³</span> à¤…à¤ªà¤¨à¥€ à¤¯à¤¾à¤¤à¥à¤°à¤¾, à¤†à¤µà¥à¤°à¤œà¤¨ à¤”à¤° à¤ªà¥à¤°à¤µà¤¾à¤¸à¤¨ à¤¸à¤‚à¤¬à¤‚à¤§à¥€ à¤ªà¥à¤°à¤¶à¥à¤¨ à¤¨à¥€à¤šà¥‡ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤</p>
                <p class="text-base"><span class="flag-icon">ğŸ‡¨ğŸ‡³</span> åœ¨ä¸‹æ–¹æå‡ºæ‚¨çš„æ—…è¡Œã€ç§»æ°‘å’Œç§»å±…é—®é¢˜ã€‚</p>
            `;
            displayMessage(combinedInitialMessage, 'gemini', false); // NÃ£o adiciona ao histÃ³rico da IA, Ã© apenas uma saudaÃ§Ã£o inicial

            // Inicia o fluxo da conversa
            handleConversationFlow(''); // Chama com input vazio para iniciar o estÃ¡gio 'initial_greeting'
        });
    </script>
</body>
</html>
